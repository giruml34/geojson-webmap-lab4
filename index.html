<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WA COVID-19 — Fully Vaccinated per 10k (Oct 25, 2021)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>
  <style>
    h2, h3 { margin: 10px; font-size: 18px; }
    h3 { font-size: 16px; }
    p { margin: 10px; }
    #map { position:absolute; top:0; bottom:0; left:0; right:0; width:100%; }
    .map-overlay {
      position:absolute; bottom:0; left:0; background:rgba(255,255,255,0.8);
      border:1px solid rgba(0,0,0,0.2); margin-left:20px; font-family:Arial, sans-serif;
      overflow:auto; border-radius:3px;
    }
    #features { top:0; height:120px; margin-top:20px; width:320px; }
    #legend {
      padding:10px; box-shadow:0 1px 2px rgba(0,0,0,0.1); line-height:18px;
      height:220px; margin-bottom:40px; width:210px;
    }
    .legend-key { display:inline-block; border-radius:20%; width:10px; height:10px; margin-right:5px; }
    .mapboxgl-canvas-container.mapboxgl-interactive,
    .mapboxgl-ctrl-group button.mapboxgl-ctrl-compass { cursor: unset; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="map-overlay" id="features">
    <h2>WA COVID-19: Fully Vaccinated per 10k (as of Oct 25, 2021)</h2>
    <div id="text-description"><p>Hover over a county</p></div>
  </div>

  <div class="map-overlay" id="legend"></div>

  <script>
    mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-120.5, 47.4],   // Washington State view
      zoom: 6.3
    });

    // ======= CHOOSE THE ATTRIBUTE TO MAP =======
    // Use ONE of: 'fullyVaxPer10k', 'casePer10k', 'deathPer10k'
    const field = 'fullyVaxPer10k';

    // ======= BINS + COLORS (adjust if you switch field) =======
    // Recommended bins:
    // - fullyVaxPer10k: [3000, 4000, 5000, 6000, 7000, 8000, 9000]
    // - casePer10k:     [500, 1000, 1500, 2000, 2500, 3000, 4000]
    // - deathPer10k:    [1, 2, 3, 4, 5, 6, 8]
    const bins =
      field === 'casePer10k'  ? [500, 1000, 1500, 2000, 2500, 3000, 4000] :
      field === 'deathPer10k' ? [1, 2, 3, 4, 5, 6, 8] :
                                [3000, 4000, 5000, 6000, 7000, 8000, 9000];

    // Pleasant sequential palette (light -> dark)
    const colors = ['#f1eef6','#d4b9da','#c994c7','#df65b0','#e7298a','#ce1256','#91003f','#4d0026'];

    function buildStepExpression(attribute, thresholds, palette){
      const expr = ['step', ['get', attribute], palette[0]];
      thresholds.forEach((t, i) => { expr.push(t, palette[i+1]); });
      return expr;
    }

    function makeRangeLabels(thresholds) {
      const labels = [];
      for (let i = 0; i < thresholds.length; i++) {
        const prev = (i === 0) ? 0 : thresholds[i-1];
        labels.push(`${prev}–${thresholds[i]-1}`);
      }
      labels.push(`${thresholds[thresholds.length-1]}+`);
      return labels;
    }

    async function geojsonFetch() {
      const resp = await fetch('assets/wa-covid-data-102521.geojson');
      const covid = await resp.json();

      map.on('load', () => {
        map.addSource('covid', { type:'geojson', data: covid });

        map.addLayer({
          id: 'covid-fill',
          type: 'fill',
          source: 'covid',
          paint: {
            'fill-color': buildStepExpression(field, bins, colors),
            'fill-outline-color': '#888',
            'fill-opacity': 0.75
          }
        });

        // Legend
        const legend = document.getElementById('legend');
        const titleText =
          field === 'casePer10k'  ? 'Cases per 10k' :
          field === 'deathPer10k' ? 'Deaths per 10k' :
                                    'Fully vaccinated per 10k';
        legend.innerHTML = `<b>${titleText}</b><br><br>`;

        const labels = makeRangeLabels(bins);
        labels.forEach((label, i) => {
          const item = document.createElement('div');
          const key = document.createElement('span');
          key.className = 'legend-key';
          key.style.backgroundColor = colors[i];
          const value = document.createElement('span');
          value.innerHTML = label;
          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
        });

        // Hover info
        map.on('mousemove', ({ point }) => {
          const features = map.queryRenderedFeatures(point, { layers: ['covid-fill'] });
          if (features.length) {
            const f = features[0].properties;
            const value = f[field];
            const county = f.name || 'Unknown';
            const label =
              field === 'casePer10k'  ? 'Cases per 10k' :
              field === 'deathPer10k' ? 'Deaths per 10k' :
                                        'Fully vaccinated per 10k';
            document.getElementById('text-description').innerHTML =
              `<h3>${county} County</h3><p><strong>${value}</strong> ${label}</p>`;
          } else {
            document.getElementById('text-description').innerHTML = '<p>Hover over a county</p>';
          }
        });
      });
    }
    geojsonFetch();
  </script>
</body>
</html>

